name: Build APK

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git zip unzip openjdk-17-jdk \
          python3-pip python3-dev \
          build-essential libffi-dev libssl-dev \
          zlib1g-dev libncurses5-dev \
          autoconf automake libtool pkg-config \
          wget curl
    
    - name: Install specific Buildozer version
      run: |
        pip install --upgrade pip setuptools wheel
        pip install "buildozer==1.4.0"  # Более старая, но стабильная версия
        pip install cython==0.29.33
    
    - name: Pre-download python-for-android
      run: |
        echo "=== Pre-downloading python-for-android ==="
        mkdir -p ~/.buildozer/android/platform
        
        # Скачиваем python-for-android напрямую (обход бага Buildozer)
        wget -q https://github.com/kivy/python-for-android/archive/refs/tags/2023.08.04.tar.gz -O p4a.tar.gz
        tar -xzf p4a.tar.gz -C ~/.buildozer/android/platform/
        mv ~/.buildozer/android/platform/python-for-android-2023.08.04 ~/.buildozer/android/platform/python-for-android
        
        # Скачиваем Android SDK отдельно
        mkdir -p ~/.buildozer/android/platform/android-sdk
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O sdk.zip
        unzip -q sdk.zip -d ~/.buildozer/android/platform/android-sdk/
        mv ~/.buildozer/android/platform/android-sdk/cmdline-tools ~/.buildozer/android/platform/android-sdk/tools
        
        # Принимаем лицензии
        yes | ~/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager --licenses >/dev/null 2>&1 || true
        
        echo "=== Pre-download completed ==="
    
    - name: Build APK (skip downloads)
      timeout-minutes: 45
      run: |
        # Устанавливаем переменные чтобы Buildozer использовал предзагруженные файлы
        export BUILDOZER_SKIP_DOWNLOAD=1
        export ANDROID_SDK_ROOT="$HOME/.buildozer/android/platform/android-sdk"
        export ANDROID_NDK_HOME="$HOME/.buildozer/android/platform/android-sdk/ndk/25.1.8937393"
        
        echo "=== Starting Buildozer ==="
        
        # Запускаем сборку в фоне с логированием
        buildozer android debug 2>&1 | tee build.log &
        BUILD_PID=$!
        
        # Ждём максимум 40 минут
        sleep 2400
        
        # Проверяем, завершился ли процесс
        if ps -p $BUILD_PID > /dev/null; then
          echo "Build is still running after 40 minutes, continuing..."
          wait $BUILD_PID
        fi
        
        echo "=== Build process finished ==="
        
        # Проверяем результат
        if [ -f "bin/*.apk" ]; then
          echo "✅ APK создан!"
          ls -la bin/*.apk
        else
          echo "❌ APK не найден"
          echo "=== Последние 30 строк лога ==="
          tail -30 build.log
          exit 1
        fi
    
    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: myapp-apk
        path: bin/*.apk
        if-no-files-found: error
