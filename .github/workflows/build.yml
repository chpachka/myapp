name: Build APK with Python-for-Android
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git openjdk-17-jdk \
          python3-pip python3-dev \
          build-essential autoconf automake libtool \
          zip unzip wget curl \
          libffi-dev libssl-dev zlib1g-dev
    
    - name: Install Android SDK
      run: |
        # Скачиваем Android SDK
        mkdir -p $HOME/android-sdk
        cd $HOME/android-sdk
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
        unzip -q cmdline-tools.zip
        mv cmdline-tools tools
        
        # Принимаем лицензии
        yes | tools/bin/sdkmanager --licenses
        
        # Устанавливаем Android API 34
        tools/bin/sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"
        
        # Устанавливаем NDK
        tools/bin/sdkmanager "ndk;25.1.8937393"
        
        # Устанавливаем переменные окружения
        echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_NDK_HOME=$HOME/android-sdk/ndk/25.1.8937393" >> $GITHUB_ENV
        echo "PATH=$PATH:$HOME/android-sdk/tools/bin:$HOME/android-sdk/platform-tools" >> $GITHUB_ENV
    
    - name: Install python-for-android and Kivy
      run: |
        pip install --upgrade pip setuptools wheel
        pip install cython==0.29.33
        pip install python-for-android
        pip install kivy==2.3.0
    
    - name: Build APK
      timeout-minutes: 35
      run: |
        # Выводим информацию о доступных API
        echo "=== Checking available APIs ==="
        $HOME/android-sdk/tools/bin/sdkmanager --list | grep "platforms;android"
        
        # Собираем APK с API 34
        p4a apk \
          --private=$(pwd) \
          --package=com.example.myapp \
          --name="MyApp" \
          --version=1.0 \
          --bootstrap=sdl2 \
          --requirements=python3,kivy==2.3.0 \
          --android-api=34 \
          --ndk-api=21 \
          --arch=arm64-v8a \
          --sdk-dir=$HOME/android-sdk \
          --ndk-dir=$HOME/android-sdk/ndk/25.1.8937393
        
        echo "=== Build completed ==="
        find . -name "*.apk" -type f 2>/dev/null | head -5
    
    - name: Check APK
      run: |
        if ls *.apk 1> /dev/null 2>&1; then
          echo "✅ APK создан успешно!"
          ls -la *.apk
        else
          echo "❌ APK не найден"
          echo "Содержимое папки:"
          ls -la
          exit 1
        fi
    
    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: myapp-apk
        path: "*.apk"
