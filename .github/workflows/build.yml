name: Minimal APK Build
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install basic tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git wget unzip openjdk-17-jdk \
          python3-pip
    
    - name: Use pre-built Android environment
      run: |
        # Используем готовый скрипт для сборки
        wget -q https://raw.githubusercontent.com/kivy/kivy/master/ci/androidsdk.sh
        chmod +x androidsdk.sh
        ./androidsdk.sh install
        
        # Устанавливаем переменные
        echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
        echo "PATH=$PATH:$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_ENV
    
    - name: Install Buildozer
      run: |
        pip install buildozer
    
    - name: Create minimal buildozer.spec
      run: |
        cat > buildozer.spec << 'SPEC'
[app]
title = MyApp
package.name = myapp
package.domain = com.example
source.dir = .
version = 1.0
requirements = python3
orientation = portrait

[buildozer]
log_level = 2
SPEC
    
    - name: Build APK (simplest)
      timeout-minutes: 45
      run: |
        echo "=== Starting buildozer ==="
        buildozer android debug 2>&1 | tail -200
        
        echo "=== Checking for APK ==="
        if find . -name "*.apk" -type f | grep -q .; then
          echo "✅ APK found!"
          find . -name "*.apk" -type f | head -5
        else
          echo "❌ No APK found"
          echo "Last 50 lines of log:"
          tail -50 ~/.local/share/buildozer/android/platform/*.log 2>/dev/null || echo "No logs"
          exit 1
        fi
    
    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: apk-file
        path: "**/*.apk"
